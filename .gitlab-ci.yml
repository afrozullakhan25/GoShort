# ============================================
# GoShort CI/CD Pipeline
# Optimized for Memory & Zero Downtime
# ============================================

stages:
  - quality
  - security
  - test
  - build
  - deploy

variables:
  CI_REGISTRY_IMAGE: registry.gitlab.com/$CI_PROJECT_PATH
  TAG_COMMIT: $CI_COMMIT_SHORT_SHA
  TAG_LATEST: latest
  TAG_BRANCH: $CI_COMMIT_REF_SLUG
  DEPLOY_PATH: "/opt/goshort"
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: unix:///var/run/docker.sock

# ============================================
# 1. Quality & Security (Backend & Frontend)
# ============================================

lint_backend:
  stage: quality
  image: golangci/golangci-lint:v1.61.0
  tags: [vps-runner]
  script:
    - cd backend
    - golangci-lint run --timeout 10m --verbose ./...
  only:
    - merge_requests
    - main
    - develop
  cache:
    key: ${CI_COMMIT_REF_SLUG}-backend
    paths:
      - backend/.cache

security_scan_backend:
  stage: security
  image: golang:1.23-alpine
  tags: [vps-runner]
  before_script:
    - apk add --no-cache git
    - go install github.com/securego/gosec/v2/cmd/gosec@v2.19.0
  script:
    - cd backend
    - $(go env GOPATH)/bin/gosec -severity medium -confidence medium -fmt json -out gosec-report.json ./... || echo "gosec warning"
  artifacts:
    reports:
      sast: backend/gosec-report.json
    expire_in: 1 week
  allow_failure: true
  only: [merge_requests, main, develop]

lint_frontend:
  stage: quality
  image: node:20-alpine
  tags: [vps-runner]
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm run lint || true
  cache:
    key: ${CI_COMMIT_REF_SLUG}-frontend
    paths:
      - frontend/node_modules/
  only: [merge_requests, main, develop]

security_scan_frontend:
  stage: security
  image: node:20-alpine
  tags: [vps-runner]
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm audit --audit-level=moderate || true
  allow_failure: true
  only: [merge_requests, main, develop]

# ============================================
# 2. Tests
# ============================================

unit_test_backend:
  stage: test
  image: golang:1.23-alpine
  tags: [vps-runner]
  services:
    - name: postgres:15-alpine
      alias: postgres
    - name: redis:7-alpine
      alias: redis
  variables:
    POSTGRES_DB: goshort_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres123
    POSTGRES_HOST_AUTH_METHOD: trust
    DB_HOST: postgres
    DB_PORT: "5432"
    DB_USER: postgres
    DB_PASSWORD: postgres123
    DB_NAME: goshort_test
    DB_SSLMODE: disable
    REDIS_HOST: redis
    REDIS_PORT: "6379"
    REDIS_PASSWORD: ""
    CGO_ENABLED: "1"
  before_script:
    - apk add --no-cache gcc musl-dev postgresql-client
    - cd backend
    - go mod download
  script:
    - go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
  only: [merge_requests, main, develop]

build_test_frontend:
  stage: test
  image: node:20-alpine
  tags: [vps-runner]
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm run build
  only: [merge_requests, main, develop]

# ============================================
# 3. Build & Push
# ============================================

build_push_backend:
  stage: build
  image: docker:25-cli
  tags: [vps-runner]
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    - cd backend
    - docker build -t $CI_REGISTRY_IMAGE/backend:$TAG_COMMIT -t $CI_REGISTRY_IMAGE/backend:$TAG_LATEST .
    - docker push $CI_REGISTRY_IMAGE/backend:$TAG_COMMIT
    - docker push $CI_REGISTRY_IMAGE/backend:$TAG_LATEST
  only: [main, develop]

build_push_frontend:
  stage: build
  image: docker:25-cli
  tags: [vps-runner]
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    - cd frontend
    - docker build -t $CI_REGISTRY_IMAGE/frontend:$TAG_COMMIT -t $CI_REGISTRY_IMAGE/frontend:$TAG_LATEST .
    - docker push $CI_REGISTRY_IMAGE/frontend:$TAG_COMMIT
    - docker push $CI_REGISTRY_IMAGE/frontend:$TAG_LATEST
  only: [main, develop]

# ============================================
# 4. Deployment (Staging & Prod)
# ============================================

# --- Staging Deployment ---
deploy_staging:
  stage: deploy
  image: docker:25-cli
  tags: [vps-runner]
  before_script:
    - mkdir -p ~/.docker/cli-plugins
    - wget -q https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 -O ~/.docker/cli-plugins/docker-compose
    - chmod +x ~/.docker/cli-plugins/docker-compose
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    - mkdir -p /opt/goshort-staging
    - cp docker-compose.yml /opt/goshort-staging/
    - cd /opt/goshort-staging
    - docker compose pull
    - docker compose up -d
    - docker image prune -af --filter "until=72h"
  environment:
    name: staging
    url: https://staging.kagnite.duckdns.org
  only:
    - develop

# --- Production Deployment (Blue-Green) ---
deploy_production:
  stage: deploy
  image: docker:25-cli
  tags: [vps-runner]
  before_script:
    - mkdir -p ~/.docker/cli-plugins
    - wget -q https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 -O ~/.docker/cli-plugins/docker-compose
    - chmod +x ~/.docker/cli-plugins/docker-compose
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    - echo "Deploying to Production..."
    
    # 1. Prepare files on server
    - mkdir -p /opt/goshort/nginx/upstreams
    - cp docker-compose.prod.yml /opt/goshort/
    - cp nginx/nginx.conf /opt/goshort/nginx/
    
    # 2. Copy the script logic (This replaces the 100 lines of YAML logic)
    - cp deploy/scripts/blue-green-deploy.sh /opt/goshort/deploy.sh
    - chmod +x /opt/goshort/deploy.sh
    
    # 3. Execute the script
    - /opt/goshort/deploy.sh
    
  environment:
    name: production
    url: https://kagnite.duckdns.org
  only:
    - main
  when: manual

# --- Rollback ---
rollback_production:
  stage: deploy
  image: docker:25-cli
  tags: [vps-runner]
  before_script:
    - mkdir -p ~/.docker/cli-plugins
    - wget -q https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 -O ~/.docker/cli-plugins/docker-compose
    - chmod +x ~/.docker/cli-plugins/docker-compose
  script:
    - cd /opt/goshort
    
    # Determine previous version logic (Simplified)
    - |
      if docker ps --format '{{.Names}}' | grep -q "goshort-backend-blue"; then
          PREVIOUS="green"
          CURRENT="blue"
      else
          PREVIOUS="blue"
          CURRENT="green"
      fi
    
    - echo "Rolling back to $PREVIOUS..."
    - docker compose -f docker-compose.prod.yml up -d backend-${PREVIOUS}
    - echo "server backend-${PREVIOUS}:8080 max_fails=3 fail_timeout=30s;" > nginx/upstreams/backend_active.conf
    - docker exec goshort-nginx nginx -s reload
    - docker stop goshort-backend-${CURRENT}
    
  environment:
    name: production
  when: manual
  only:
    - main