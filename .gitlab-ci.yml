stages:
  - quality
  - security
  - test
  - build
  - deploy

variables:
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  TAG_COMMIT: $CI_COMMIT_SHORT_SHA
  TAG_LATEST: latest

# ---------------------------------------------------------------------------
# Stage 1: Code Quality
# ---------------------------------------------------------------------------
lint_code:
  stage: quality
  image: golangci/golangci-lint:v1.61.0
  tags:
    - vps-runner
  script:
    - echo "Linting code..."
    - golangci-lint run --timeout 10m --verbose
  allow_failure: false



# ---------------------------------------------------------------------------
# Stage 2: Security Scan
# ---------------------------------------------------------------------------
security_scan:
  stage: security
  image: golang:1.24
  before_script:
    - go install github.com/securego/gosec/v2/cmd/gosec@latest
  script:
    - $(go env GOPATH)/bin/gosec -severity medium ./...
  tags:
    - vps-runner
  allow_failure: false



# ---------------------------------------------------------------------------
# Stage 3: Unit Tests
# ---------------------------------------------------------------------------
unit_test:
  stage: test
  image: golang:1.24
  script:
    - echo "Running unit tests..."
    - go test -v -cover ./...
  coverage: '/coverage: \d+\.\d+%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

# ---------------------------------------------------------------------------
# Stage 4: Build & Push Docker Image
# ---------------------------------------------------------------------------
build_push_docker:
  stage: build
  image: docker:24-cli
  services:
    - name: docker:24-dind
      command: ["--tls=false"]
  variables:
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    - echo "Building Docker image..."
    - docker info
    - docker build -t $IMAGE_NAME:$TAG_COMMIT -t $IMAGE_NAME:$TAG_LATEST .
    - echo "Pushing to GitLab registry..."
    - docker push $IMAGE_NAME:$TAG_COMMIT
    - docker push $IMAGE_NAME:$TAG_LATEST
  tags:
    - vps-runner
  only:
    - main
    - develop


# ---------------------------------------------------------------------------
# Stage 5: Deploy to Production VPS
# ---------------------------------------------------------------------------
deploy_prod:
  stage: deploy
  image: alpine:latest
  tags:
    - vps-runner
  variables:
    SSH_PORT: "8787"

  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config

  script:
    - echo "Deploying to $SERVER_IP..."
    
    # Main deployment logic over SSH
    - |
      ssh -p $SSH_PORT kagnite@$SERVER_IP "
        set -e
        
        # Login using GitLab CI variables
        echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY

        docker pull $IMAGE_NAME:$TAG_LATEST

        docker stop goshort_app || true
        docker rm goshort_app || true

        docker image prune -af --filter 'label!=keep'

        docker run -d \
          --name goshort_app \
          --restart always \
          -p 80:8080 \
          --health-cmd='curl -f http://localhost:8080/ || exit 1' \
          --health-interval=30s \
          --health-timeout=10s \
          --health-retries=3 \
          $IMAGE_NAME:$TAG_LATEST
      "

    - sleep 10

    # Post-deployment verification
    - |
      ssh -p $SSH_PORT kagnite@$SERVER_IP "
        if ! docker ps | grep -q goshort_app; then
          echo 'Container failed to start'
          exit 1
        fi
        curl --fail --max-time 10 http://localhost:8080/ || exit 1
      "

    - echo "Deployment successful!"

  environment:
    name: production
    url: http://$SERVER_IP
  only:
    - main

# ---------------------------------------------------------------------------
# Stage 6: Stop Production
# ---------------------------------------------------------------------------
stop_prod:
  stage: deploy
  image: alpine:latest
  tags:
    - vps-runner

  variables:
    SSH_PORT: "8787"

  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo -e "Host *\n  StrictHostKeyChecking no\n" > ~/.ssh/config

  script:
    - ssh -p $SSH_PORT kagnite@$SERVER_IP "
        docker stop goshort_app || true &&
        docker rm goshort_app || true
      "

  when: manual

  environment:
    name: production
    action: stop
