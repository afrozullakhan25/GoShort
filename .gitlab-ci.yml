# ============================================
# GoShort CI/CD Pipeline
# ============================================

stages:
  - quality
  - security
  - test
  - build
  - deploy

variables:
  CI_REGISTRY_IMAGE: registry.gitlab.com/$CI_PROJECT_PATH
  TAG_COMMIT: $CI_COMMIT_SHORT_SHA
  TAG_LATEST: latest
  TAG_BRANCH: $CI_COMMIT_REF_SLUG
  SSH_PORT: "22"
  DEPLOY_PATH: "/opt/goshort"

# ============================================
# Backend Jobs
# ============================================

lint_backend:
  stage: quality
  image: golangci/golangci-lint:v1.61.0
  tags: [vps-runner]
  script:
    - cd backend
    - golangci-lint run --timeout 10m ./...
  only:
    - main
    - develop

security_scan_backend:
  stage: security
  image: golang:1.23-alpine
  tags: [vps-runner]
  before_script:
    - apk add --no-cache git
    - go install github.com/securego/gosec/v2/cmd/gosec@v2.19.0
  script:
    - cd backend
    - $(go env GOPATH)/bin/gosec ./... || true
  only:
    - main
    - develop
  allow_failure: true

unit_test_backend:
  stage: test
  image: golang:1.23-alpine
  tags: [vps-runner]
  services:
    - postgres:15-alpine
    - redis:7-alpine
  variables:
    POSTGRES_DB: goshort_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres123
    DB_HOST: postgres
    DB_PORT: "5432"
    REDIS_HOST: redis
    REDIS_PORT: "6379"
  before_script:
    - apk add --no-cache gcc musl-dev postgresql-client
    - cd backend
    - go mod download
  script:
    - go test -v ./...
  only:
    - main
    - develop
  allow_failure: true

# ============================================
# Frontend Jobs
# ============================================

lint_frontend:
  stage: quality
  image: node:20-alpine
  tags: [vps-runner]
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm run lint || true
  only:
    - main
    - develop
  allow_failure: true

build_test_frontend:
  stage: test
  image: node:20-alpine
  tags: [vps-runner]
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm run build
  only:
    - main
    - develop

# ============================================
# Build & Push - روی خود سرور
# ============================================

build_push_images:
  stage: build
  tags: [vps-runner]
  image: alpine:3.19
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - ssh-keyscan -p "$SSH_PORT" -H "$SERVER_IP" >> ~/.ssh/known_hosts
  script:
    - |
      ssh -p "$SSH_PORT" $SERVER_USER@"$SERVER_IP" bash <<'ENDSSH'
      cd /opt/goshort
      
      echo "Login to registry..."
      echo "${CI_REGISTRY_PASSWORD}" | docker login -u "${CI_REGISTRY_USER}" --password-stdin registry.gitlab.com
      
      echo "Building backend..."
      cd backend
      docker build -t registry.gitlab.com/kagnite-group/kagnite-project/backend:latest .
      docker push registry.gitlab.com/kagnite-group/kagnite-project/backend:latest
      
      echo "Building frontend..."
      cd ../frontend
      docker build -t registry.gitlab.com/kagnite-group/kagnite-project/frontend:latest .
      docker push registry.gitlab.com/kagnite-group/kagnite-project/frontend:latest
      
      echo "Build completed!"
      ENDSSH
  only:
    - main

# ============================================
# Deploy
# ============================================

deploy_production:
  stage: deploy
  tags: [vps-runner]
  image: alpine:3.19
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - ssh-keyscan -p "$SSH_PORT" -H "$SERVER_IP" >> ~/.ssh/known_hosts
  script:
    - |
      ssh -p "$SSH_PORT" $SERVER_USER@"$SERVER_IP" bash <<'ENDSSH'
      cd /opt/goshort
      
      echo "Pulling latest images..."
      docker-compose -f docker-compose.prod.yml pull
      
      echo "Restarting services..."
      docker-compose -f docker-compose.prod.yml up -d
      
      echo "Deployment completed!"
      ENDSSH
  environment:
    name: production
    url: https://yourdomain.com
  only:
    - main
  when: manual

rollback_production:
  stage: deploy
  tags: [vps-runner]
  image: alpine:3.19
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - ssh-keyscan -p "$SSH_PORT" -H "$SERVER_IP" >> ~/.ssh/known_hosts
  script:
    - |
      ssh -p "$SSH_PORT" $SERVER_USER@"$SERVER_IP" bash <<'ENDSSH'
      cd /opt/goshort
      docker-compose -f docker-compose.prod.yml down
      docker-compose -f docker-compose.prod.yml up -d
      ENDSSH
  only:
    - main
  when: manual
